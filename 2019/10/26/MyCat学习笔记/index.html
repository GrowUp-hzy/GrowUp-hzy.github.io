<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/cat.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat.jpg">
  <link rel="mask-icon" href="/images/cat.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"growup-hzy.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Mycat数据库中间件 1、数据库中间件： 是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。 例子：Tomcat，web中间件。 数据库中间件：连接java应用程序和数据库  2、为什么要用Mycat？   Java与数据库紧耦合 高访问量高并发对数据库的压力 读写请求数据不一致   &#x3D;&#x3D;mysql单表瓶颈1000w数据,单库瓶颈5000w数据&#x3D;&#x3D; 数据库中间件对比:  Myca">
<meta property="og:type" content="article">
<meta property="og:title" content="MyCat学习笔记">
<meta property="og:url" content="https://growup-hzy.github.io/2019/10/26/MyCat%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="煜虚人渊">
<meta property="og:description" content="Mycat数据库中间件 1、数据库中间件： 是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。 例子：Tomcat，web中间件。 数据库中间件：连接java应用程序和数据库  2、为什么要用Mycat？   Java与数据库紧耦合 高访问量高并发对数据库的压力 读写请求数据不一致   &#x3D;&#x3D;mysql单表瓶颈1000w数据,单库瓶颈5000w数据&#x3D;&#x3D; 数据库中间件对比:  Myca">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="d:/study/Markdown/images/image-20200517142233265.png">
<meta property="og:image" content="https://i.loli.net/2020/05/17/xW3Nsw9V5tdliRO.png">
<meta property="og:image" content="https://i.loli.net/2020/05/17/orkKWT3nDh8YqXR.png">
<meta property="og:image" content="https://i.loli.net/2020/05/17/2RzmPCoSs8QYHpk.png">
<meta property="og:image" content="https://i.loli.net/2020/05/18/xutYMTd5vqngBhW.png">
<meta property="og:image" content="https://i.loli.net/2020/05/18/EQKzcxyL7TD6JCY.png">
<meta property="og:image" content="https://i.loli.net/2020/05/18/YyWeo3ACMcrHqhf.png">
<meta property="og:image" content="https://i.loli.net/2020/05/18/wcoehs4nuRV2QXC.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/mqtiIOo78aPzRCM.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/PmWTrkAGIJbSfU9.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/QfZp5g2eSaNi8DB.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/5NiYIbGAkLgMw4W.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/bhZ6VcOHtdqkYJX.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/ysuzLmniYANdl7c.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/ifvRxBLUYjcDp7G.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/RNLUr5a6AsQtknK.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/1RouN4We3VJlOTz.png">
<meta property="og:image" content="https://i.loli.net/2020/05/19/PcFlzWhGDpCQa1r.png">
<meta property="article:published_time" content="2019-10-26T08:23:46.000Z">
<meta property="article:modified_time" content="2021-04-02T07:07:20.467Z">
<meta property="article:author" content="hzy">
<meta property="article:tag" content="数据库中间件">
<meta property="article:tag" content="分库分表">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/study/Markdown/images/image-20200517142233265.png">

<link rel="canonical" href="https://growup-hzy.github.io/2019/10/26/MyCat%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MyCat学习笔记 | 煜虚人渊</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">煜虚人渊</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个不断成长的Java开发人员</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://growup-hzy.github.io/2019/10/26/MyCat%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/cat.jpg">
      <meta itemprop="name" content="hzy">
      <meta itemprop="description" content="记录学习的过程">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="煜虚人渊">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MyCat学习笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-26 16:23:46" itemprop="dateCreated datePublished" datetime="2019-10-26T16:23:46+08:00">2019-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-02 15:07:20" itemprop="dateModified" datetime="2021-04-02T15:07:20+08:00">2021-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Mycat数据库中间件"><a href="#Mycat数据库中间件" class="headerlink" title="Mycat数据库中间件"></a>Mycat数据库中间件</h1><p> 1、<strong>数据库中间件</strong>：</p>
<p>是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。 例子：Tomcat，web中间件。 数据库中间件：连接java应用程序和数据库 </p>
<p>2、<strong>为什么要用Mycat？</strong> </p>
<ul>
<li>Java与数据库紧耦合</li>
<li>高访问量高并发对数据库的压力</li>
<li>读写请求数据不一致 </li>
</ul>
<p>==mysql单表瓶颈1000w数据,单库瓶颈5000w数据==</p>
<p><strong>数据库中间件对比:</strong></p>
<p><img src="D:\study\Markdown\images\image-20200517142233265.png" alt="image-20200517142233265"></p>
<p><strong>Mycat的官网:</strong>    <a target="_blank" rel="noopener" href="http://www.mycat.io/">http://www.mycat.io/</a> </p>
<p><strong>Mycat能干什么:</strong></p>
<ul>
<li><p><strong>读写分离</strong><img src="https://i.loli.net/2020/05/17/xW3Nsw9V5tdliRO.png" alt="image-20200517142440990"></p>
</li>
<li><p><strong>数据分片</strong>  垂直拆分（分库）、水平拆分（分表）、垂直+水平拆分（分库分表)<img src="https://i.loli.net/2020/05/17/orkKWT3nDh8YqXR.png" alt="image-20200517142902826"></p>
</li>
<li><p><strong>多数据源整合</strong> <img src="https://i.loli.net/2020/05/17/2RzmPCoSs8QYHpk.png" alt="image-20200517143305538"></p>
</li>
</ul>
<p><strong>原理:</strong></p>
<p>Mycat 的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的 SQL 语句，首先对 SQL<br>语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发<br>往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户</p>
<h2 id="安装启动"><a href="#安装启动" class="headerlink" title="安装启动"></a>安装启动</h2><p><strong>1、解压后即可使用</strong><br>解压缩文件拷贝到 linux 下 /usr/local/<br><strong>2、三个配置文件</strong> </p>
<ul>
<li>schema.xml：定义逻辑库，表、分片节点等内容 </li>
<li>rule.xml：定义分片规则 </li>
<li>server.xml：定义用户以及系统相关变量，如端口等 </li>
</ul>
<p><strong>3、修改配置文件server.xml 修改用户信息，与MySQL区分</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--用户名--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span>     <span class="comment">&lt;!--密码--&gt;</span>           </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span> 		<span class="comment">&lt;!--管理的库--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>schemas</code>:数据库名，这里会和schema.xml中的配置关联，多个用逗号分开，例如需要这个用户需要管理两个数据库db1,db2，则配置db1,db2</p>
<p><strong>4.修改配置文件 schema.xml</strong> </p>
<p>删除<code>&lt;schema&gt;</code>标签间的表信息配置<code> dataNode=&quot;dn1&quot;</code>， <code>&lt;dataNode&gt;</code>标签只留一个， <code>&lt;dataHost&gt;</code>标签只留一个， <code>&lt;writeHost&gt; </code>,<code>&lt;readHost&gt;</code>只留一对 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 逻辑库  --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>  <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 逻辑表 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 数据节点 database填写真实数据库--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;testdb&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 数据主机 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 心跳检测 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 写主机 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.107.132:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">				   <span class="attr">password</span>=<span class="string">&quot;000000&quot;</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 读主机 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.107.108:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;hzy&quot;</span> <span class="attr">password</span>=<span class="string">&quot;000000&quot;</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>5.验证数据库访问情况</strong> </p>
<p>Mycat 作为数据库中间件要和数据库部署在不同机器上，所以要验证远程访问情况。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -uhzy -p000000 -h 192.168.107.108 -P 3306 </span><br><span class="line">mysql -uroot -p000000 -h 192.168.107.132 -P 3306 </span><br><span class="line"> </span><br><span class="line"><span class="comment">#如远程访问报错，请建对应用户 </span></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> root@<span class="string">&#x27;缺少的host&#x27;</span>  <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">&#x27;000000&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p><strong>6.启动mycat</strong></p>
<ul>
<li>控制台启动 ：去 mycat/bin 目录下执行 ./mycat console </li>
<li>后台启动 ：去 mycat/bin 目录下 ./mycat start </li>
</ul>
<p>为了能第一时间看到启动日志，方便定位问题，我们选择控制台启动。</p>
<p><strong>7.登录mycat</strong></p>
<ul>
<li>登录后台管理窗口 </li>
</ul>
<p>此登录方式用于管理维护 Mycat </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -umycat -p123456 -P 9066 -h 192.168.140.128 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">常用命令如下： </span></span><br><span class="line">show database;</span><br><span class="line">show @@help;</span><br></pre></td></tr></table></figure>

<ul>
<li>登录数据窗口 </li>
</ul>
<p>此登录方式用于通过 Mycat 查询数据，我们选择这种方式访问Mycat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456 -P 8066 -h 192.168.107.132 </span><br></pre></td></tr></table></figure>

<h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>我们通过 Mycat 和 MySQL 的<strong>主从复制</strong>配合搭建数据库的<strong>读写分离</strong>，实现 MySQL 的高可用性。<br>我们将搭建：一主一从、双主双从两种读写分离模式。 </p>
<p><img src="https://i.loli.net/2020/05/18/xutYMTd5vqngBhW.png" alt="image-20200518102823097"></p>
<p><strong>mysql主从复制原理:</strong></p>
<p><img src="https://i.loli.net/2020/05/18/EQKzcxyL7TD6JCY.png" alt="image-20200518103132114"></p>
<p>与redis不同的是,redis从机会把主机的数据从头到尾复制,而mysql从机只会从接入点开始复制; 并且会发生多次IO有延时问题</p>
<h3 id="主机配置"><a href="#主机配置" class="headerlink" title="主机配置"></a>主机配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件：</span><br><span class="line">vim &#x2F;etc&#x2F;my.cnf </span><br><span class="line">#主服务器唯一ID </span><br><span class="line">server-id&#x3D;1  </span><br><span class="line">#启用二进制日志 </span><br><span class="line">log-bin&#x3D;mysql-bin </span><br><span class="line"># 设置不要复制的数据库(可设置多个) </span><br><span class="line">binlog-ignore-db&#x3D;mysql </span><br><span class="line">binlog-ignore-db&#x3D;information_schema </span><br><span class="line">#设置需要复制的数据库 </span><br><span class="line">binlog-do-db&#x3D;需要复制的主数据库名字 </span><br><span class="line">#设置logbin格式 </span><br><span class="line">binlog_format&#x3D;STATEMENT </span><br></pre></td></tr></table></figure>

<blockquote>
<p>binlog的三种模式:<a target="_blank" rel="noopener" href="https://blog.csdn.net/vhomes/article/details/8082734">https://blog.csdn.net/vhomes/article/details/8082734</a></p>
</blockquote>
<h3 id="从机配置"><a href="#从机配置" class="headerlink" title="从机配置"></a>从机配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;my.cnf </span><br><span class="line">#从服务器唯一ID </span><br><span class="line">server-id&#x3D;2  </span><br><span class="line">#启用中继日志 </span><br><span class="line">relay-log&#x3D;mysql-relay </span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>重启服务</strong>:<code>systemctl restart mysqld</code></p>
</li>
<li><p><strong>确认防火墙已关闭:</strong><code>systemctl status firewalld</code></p>
</li>
<li><p><strong>在主机MySQL里执行授权命令</strong>: <code>GRANT REPLICATION SLAVE ON *.* TO &#39;slave&#39;@&#39;%&#39; IDENTIFIED BY &#39;123123&#39;; </code></p>
</li>
</ul>
<p>如果报错:Your password does not satisfy the current policy requirements,请执行:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global validate_password_policy&#x3D;0;</span><br><span class="line">set global validate_password_length&#x3D;4;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>查看主机状态:</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>;</span><br><span class="line">+<span class="comment">------------------+----------+--------------+--------------------------+-------------------+</span></span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB         | Executed_Gtid_Set |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+--------------------------+-------------------+</span></span><br><span class="line">| mysql-bin.000001 |      438 | testdb       | mysql,information_schema |                   |</span><br><span class="line">+<span class="comment">------------------+----------+--------------+--------------------------+-------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>记录下File和Position的值, 执行完此步骤后不要再操作主服务器MySQL，防止主服务器状态值变化 </p>
<ul>
<li><strong>在从机上配置需要复制的主机</strong> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#复制主机的命令 </span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;主机的IP地址&#39;, </span><br><span class="line">MASTER_USER&#x3D;&#39;slave&#39;, </span><br><span class="line">MASTER_PASSWORD&#x3D;&#39;123123&#39;, </span><br><span class="line">MASTER_LOG_FILE&#x3D;&#39;mysql-bin.具体数字&#39;,</span><br><span class="line">MASTER_LOG_POS&#x3D;具体值; </span><br><span class="line">#启动从服务器复制功能 </span><br><span class="line">start slave; </span><br><span class="line">#查看从服务器状态 </span><br><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<p><strong>例子:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;192.168.107.132&#39;, </span><br><span class="line">MASTER_USER&#x3D;&#39;slave&#39;, </span><br><span class="line">MASTER_PASSWORD&#x3D;&#39;123123&#39;, </span><br><span class="line">MASTER_LOG_FILE&#x3D;&#39;mysql-bin.000003&#39;,</span><br><span class="line">MASTER_LOG_POS&#x3D;154; </span><br></pre></td></tr></table></figure>

<p>如果之前配置过主从复制,需要先重置<code>stop slave;</code>, <code>reset master;</code></p>
<p>接着启动从服务器复制功能 <code>start slave; </code></p>
<p>查看从服务器状态 <code>show slave status\G</code>(不要加分号)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#这两项尾Yes即为成功</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">#如果失败可查看Error项</span><br><span class="line">Last_Errno: 0</span><br><span class="line">Last_Error: </span><br><span class="line">Last_IO_Errno: 0</span><br><span class="line">Last_IO_Error: </span><br><span class="line">Last_SQL_Errno: 0</span><br><span class="line">Last_SQL_Error: </span><br></pre></td></tr></table></figure>

<p> <strong>主机新建库(my.cnf中规定的库)、新建表、insert 记录，从机复制</strong> </p>
<h3 id="一主一从"><a href="#一主一从" class="headerlink" title="一主一从"></a>一主一从</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 写主机 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.107.132:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">				   <span class="attr">password</span>=<span class="string">&quot;000000&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 读主机 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.107.108:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;hzy&quot;</span> <span class="attr">password</span>=<span class="string">&quot;000000&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>启动mycat</strong></p>
<p>在写主机数据库表mytbl中插入带系统变量数据，造成主从数据不一致 <code>INSERT INTO mytbl VALUES(2,@@hostname); </code></p>
<p><strong>使用mycat查询,可以看到mycat操作的是主机数据</strong></p>
<p>原因是我们没有指定数据库访问的<strong>负载策略</strong><code>balance</code></p>
<ul>
<li><p>balance=”0”, 不开启读写分离机制，所有读操作都发送到当前可用的 writeHost 上。 </p>
</li>
<li><p>balance=”1”，全部的 readHost 与 stand by writeHost 参与 select 语句的负载均衡，简单的说，当双主双从 模式(M1-&gt;S1，M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情况下，M2,S1,S2 都参与 select 语句的负载均衡。 </p>
</li>
<li><p>balance=”2”，所有读操作都随机的在 writeHost、readhost 上分发。 </p>
</li>
<li><p>balance=”3”，所有读请求随机的分发到 readhost 执行，writerHost 不负担读压力 </p>
</li>
</ul>
<p>==双主双从选1,单主单从或多从选3==</p>
<p><strong>修改schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 数据主机 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="双主双从"><a href="#双主双从" class="headerlink" title="双主双从"></a>双主双从</h3><p>一个主机 m1 用于处理所有写请求，它的从机 s1 和另一台主机 m2 还有它的从机 s2 负责所有读请<br>求。当 m1 主机宕机后，m2 主机负责写请求，m1、m2 互为备机。</p>
<p><img src="https://i.loli.net/2020/05/18/YyWeo3ACMcrHqhf.png" alt="image-20200518133105869"></p>
<p><strong>Master1配置</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件：vim &#x2F;etc&#x2F;my.cnf </span><br><span class="line">#主服务器唯一ID </span><br><span class="line">server-id&#x3D;1  </span><br><span class="line">#启用二进制日志 </span><br><span class="line">log-bin&#x3D;mysql-bin </span><br><span class="line"># 设置不要复制的数据库(可设置多个) </span><br><span class="line">binlog-ignore-db&#x3D;mysql </span><br><span class="line">binlog-ignore-db&#x3D;information_schema </span><br><span class="line">#设置需要复制的数据库 </span><br><span class="line">binlog-do-db&#x3D;需要复制的主数据库名字 </span><br><span class="line">#设置logbin格式 </span><br><span class="line">binlog_format&#x3D;STATEMENT </span><br><span class="line"># 在作为从数据库的时候，有写入操作也要更新二进制日志文件 </span><br><span class="line">log-slave-updates  </span><br><span class="line">#表示自增长字段每次递增的量，指字段一次递增多少，其默认值是1，取值范围是1 .. 65535 </span><br><span class="line">auto-increment-increment&#x3D;2  </span><br><span class="line"># 表示自增长字段从哪个数开始，指自增字段的起始值，他的取值范围是1 .. 65535 </span><br><span class="line">auto-increment-offset&#x3D;1  </span><br></pre></td></tr></table></figure>

<p><strong>Master2配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件：vim &#x2F;etc&#x2F;my.cnf </span><br><span class="line">#主服务器唯一ID </span><br><span class="line">server-id&#x3D;3  </span><br><span class="line">#启用二进制日志 </span><br><span class="line">log-bin&#x3D;mysql-bin </span><br><span class="line">#设置不要复制的数据库(可设置多个) </span><br><span class="line">binlog-ignore-db&#x3D;mysql </span><br><span class="line">binlog-ignore-db&#x3D;information_schema </span><br><span class="line">#设置需要复制的数据库 </span><br><span class="line">binlog-do-db&#x3D;需要复制的主数据库名字 </span><br><span class="line">#设置logbin格式 </span><br><span class="line">binlog_format&#x3D;STATEMENT </span><br><span class="line"># 在作为从数据库的时候，有写入操作也要更新二进制日志文件 </span><br><span class="line">log-slave-updates  </span><br><span class="line">#表示自增长字段每次递增的量，指自增字段的起始值，其默认值是1，取值范围是1 .. 65535 </span><br><span class="line">auto-increment-increment&#x3D;2  </span><br><span class="line"># 表示自增长字段从哪个数开始，指自增字段的起始值，他的取值范围是1 .. 6553 </span><br><span class="line">65535 auto-increment-offset&#x3D;2 </span><br></pre></td></tr></table></figure>

<p>==注意:auto-increment-offset不可以是重复的==</p>
<p><strong>Slave1配置</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#从服务器唯一ID </span><br><span class="line">server-id&#x3D;2  </span><br><span class="line">#启用中继日志 </span><br><span class="line">relay-log&#x3D;mysql-relay </span><br></pre></td></tr></table></figure>

<p><strong>Slave2配置</strong>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#从服务器唯一ID </span><br><span class="line">server-id&#x3D;4  </span><br><span class="line">#启用中继日志 </span><br><span class="line">relay-log&#x3D;mysql-relay </span><br></pre></td></tr></table></figure>

<ul>
<li>双主机、双从机重启 mysql 服务 </li>
<li>主机从机都关闭防火墙 </li>
<li>在两台主机上建立帐户并授权 slave </li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在主机MySQL里执行授权命令 </span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">&#x27;123123&#x27;</span>; </span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>查看两台主机的状态</strong><code>show master status;</code>,记录binlogid和接入点</p>
</li>
<li><p><strong>设置两台从机的主机</strong>,Slava1 复制 Master1，Slava2 复制 Master2 </p>
</li>
<li><p><strong>两台主机互备</strong>,Master2 复制 Master1，Master1 复制 Master2 </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">reset master;</span><br><span class="line">#复制主机的命令 </span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;主机的IP地址&#39;, </span><br><span class="line">MASTER_USER&#x3D;&#39;slave&#39;, </span><br><span class="line">MASTER_PASSWORD&#x3D;&#39;123123&#39;, </span><br><span class="line">MASTER_LOG_FILE&#x3D;&#39;mysql-bin.具体数字&#39;,</span><br><span class="line">MASTER_LOG_POS&#x3D;具体值; </span><br><span class="line">#启动从服务器复制功能 </span><br><span class="line">start slave; </span><br><span class="line">#查看从服务器状态 </span><br><span class="line">show slave status\G</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>修改schema.xml</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;testdb&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span>                           <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span>                </span><br><span class="line">    <span class="comment">&lt;!-- can have multi write hosts --&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.128:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>                                    <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span>                         </span><br><span class="line">        <span class="comment">&lt;!-- can have multi read hosts --&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.127:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>/&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.126:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>                                    <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span>                         </span><br><span class="line">        <span class="comment">&lt;!-- can have multi read hosts --&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.125:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>/&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span>         </span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span> </span><br><span class="line">#balance=&quot;1&quot;: 全部的readHost与stand by writeHost参与select语句的负载均衡。 </span><br><span class="line">#writeType=&quot;0&quot;: 所有写操作发送到配置的第一个writeHost，第一个挂了切到还生存的第二个 </span><br><span class="line">#writeHost，重新启动后以切换后的为准，切换记录在配置文件中:dnindex.properties 。 </span><br><span class="line">#switchType=&quot;1&quot;: 1 默认值，自动切换。 </span><br><span class="line">#              -1 表示不自动切换 </span><br><span class="line">#              2 基于 MySQL 主从同步的状态决定是否切换。 </span><br></pre></td></tr></table></figure>

<ul>
<li><p>**验证主从复制:**Master1 主机新建库、新建表、insert 记录，Master2 和从机复制 </p>
</li>
<li><p><strong>验证读写分离:</strong></p>
</li>
</ul>
<p>在写主机Master1数据库表mytbl中插入带系统变量数据，造成主从数据不一致</p>
<p> <code>INSERT INTO mytbl VALUES(3,@@hostname); </code>,</p>
<p>在Mycat里查询mytbl表,可以看到查询语句在Master2（host81）、Slava1（host80）、Slava2（host82） 主从三个主机间切换; </p>
<p>停止数据库Master1 在Mycat里插入数据依然成功，Master2自动切换为写主机 </p>
<h2 id="垂直拆分——分库"><a href="#垂直拆分——分库" class="headerlink" title="垂直拆分——分库"></a>垂直拆分——分库</h2><p>按照业务将表进行分类（或者 Schema）来切分到不同的数据库（主机）之上，这种切可以称之为数据的垂直（纵向）切分</p>
<p><strong>分库的原则</strong>：有紧密关联关系的表应该在一个库里，相互没有关联关系的表可以分到不同的库里,因为分库的表不可以关联查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#客户表  rows:20万  </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> customer( </span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT, </span><br><span class="line">    <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">200</span>), </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>) </span><br><span class="line">);</span><br><span class="line"><span class="comment">#订单表  rows:600万 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT, </span><br><span class="line">    order_type <span class="built_in">INT</span>, </span><br><span class="line">    customer_id <span class="built_in">INT</span>, </span><br><span class="line">    amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),     </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);  </span><br><span class="line"><span class="comment">#订单详细表 rows:600万 </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders_detail(     </span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,     </span><br><span class="line">    detail <span class="built_in">VARCHAR</span>(<span class="number">2000</span>),     </span><br><span class="line">    order_id <span class="built_in">INT</span>,     </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>) </span><br><span class="line">); </span><br><span class="line"><span class="comment">#订单状态字典表 rows:20</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dict_order_type(     </span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> AUTO_INCREMENT,     </span><br><span class="line">    order_type <span class="built_in">VARCHAR</span>(<span class="number">200</span>),     </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>) </span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p>客户表分在一个数据库，另外三张都需要关联查询，分在另外一个数据库。 </p>
<p><strong>1.修改 schema 配置文件</strong> </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 逻辑库  --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 配置customer表分配到dn2 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 数据节点 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orders&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orders&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- host1 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 心跳检测 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 写主机 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.107.132:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span></span></span><br><span class="line"><span class="tag">				   <span class="attr">password</span>=<span class="string">&quot;000000&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- host2 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">			  <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 心跳检测 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 写主机 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.107.108:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;hzy&quot;</span></span></span><br><span class="line"><span class="tag">				   <span class="attr">password</span>=<span class="string">&quot;000000&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过mycat操作逻辑库默认执行到<code>dataNode=&quot;dn1&quot;</code>,我们指定了<code>customer</code>分配到<code>dataNode=&quot;dn2&quot;</code></p>
<p><code>balance=&quot;0&quot;</code>不设置读写分离</p>
<p><strong>2.两台机器分别创建新的的数据库</strong> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> orders; </span><br></pre></td></tr></table></figure>

<p><strong>3.启动 Mycat</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mycat console </span><br></pre></td></tr></table></figure>

<p><strong>4.访问 Mycat 进行分库</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -umycat -p123456 -h 192.168.140.128 -P 8066 </span><br><span class="line">#切换到 TESTDB </span><br><span class="line">#创建 4 张表 </span><br><span class="line">#查看表信息，可以看到成功分库 </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/18/wcoehs4nuRV2QXC.png" alt="image-20200518150053652"></p>
<h2 id="水平拆分——分表"><a href="#水平拆分——分表" class="headerlink" title="水平拆分——分表"></a>水平拆分——分表</h2><p>根据表中的数据的逻辑关系按照某个字段的某种规则，将同一个表中的数据按照某种条件拆分到多台数据库（主机）上面，这种切分称之为数据的水平（横向）切分</p>
<p>MySQL 单表存储数据条数是有瓶颈的，单表达到 1000 万条数据就达到了瓶颈，会影响查询效率，<br>需要进行水平拆分（分表）进行优化。<br>例如：例子中的 orders、orders_detail 都已经达到 600 万行数据，需要进行分表优化。 </p>
<p><strong>1.分表字段</strong> ,以 orders 表为例，可以根据不同自字段进行分表 </p>
<ul>
<li>**id主键或创建时间:**查询订单注重时效，历史订单被查询的次数少，如此分片会造成一个节点访问多，一个访问少，不平均。 </li>
<li><strong>customer_id（客户 id）:</strong> 根据客户 id 去分，两个节点访问平均，一个客户的所有订单都在同一个节点 </li>
</ul>
<p><strong>2.修改schema 配置文件</strong> </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 逻辑库  --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 配置customer表分配到dn2 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span>  <span class="attr">rule</span>=<span class="string">&quot;mod_rule&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>orders</strong>表被划分到两个数据节点<code>dn1,dn2</code>,<code>mod_rule</code>分片规则名称</p>
<p>3.<strong>修改rule 配置文件</strong></p>
<p>定义<code>mod_rule</code>分片规则,并指定规则适用字段为 <code>customer_id</code>，选择分片算法 <code>mod-long</code>（对字段求模运算），customer_id 对两个节点求模，根据结果分片 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod_rule&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>customer_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置算法 mod-long 参数 count 为 2，两个节点--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 多少个数据节点 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>4.测试分表</strong></p>
<ul>
<li><p>在数据节点 dn2 上建 orders 表 </p>
</li>
<li><p>重启 Mycat，让配置生效 </p>
</li>
<li><p>访问 Mycat 实现分片 </p>
</li>
<li><p>在 mycat 里向 orders 表插入数据，INSERT 字段不能省略 INSERT INTO </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">100100</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">100300</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="number">101</span>,<span class="number">101</span>,<span class="number">120000</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="number">101</span>,<span class="number">101</span>,<span class="number">103000</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="number">102</span>,<span class="number">101</span>,<span class="number">100400</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders(<span class="keyword">id</span>,order_type,customer_id,amount) <span class="keyword">VALUES</span>(<span class="number">6</span>,<span class="number">102</span>,<span class="number">100</span>,<span class="number">100020</span>); </span><br></pre></td></tr></table></figure>

<p>在mycat、dn1、dn2中查看orders表数据，分表成功 </p>
<p><img src="https://i.loli.net/2020/05/19/mqtiIOo78aPzRCM.png" alt="image-20200519102119636"></p>
</li>
</ul>
<h2 id="Mycat-的分片-“join”"><a href="#Mycat-的分片-“join”" class="headerlink" title="Mycat 的分片 “join”"></a>Mycat 的分片 “join”</h2><p>Orders 订单表已经进行分表操作了，和它关联的 orders_detail 订单详情表如何进行 join 查询。 </p>
<p><strong>orders_detail 也要进行分片操作</strong>。Join 的原理如下图： </p>
<p><img src="https://i.loli.net/2020/05/19/PmWTrkAGIJbSfU9.png" alt="image-20200519102406924"></p>
<h3 id="ER-表"><a href="#ER-表" class="headerlink" title="ER 表"></a><strong>ER 表</strong></h3><p>Mycat 借鉴了 NewSQL 领域的新秀 Foundation DB 的设计思路，Foundation DB 创新性的提<br>出了 Table Group 的概念，其将子表的存储位置依赖于主表，并且物理上紧邻存放，因此彻底解决了<br>JION 的效率和性能问 题，根据这一思路，提出了基于 E-R 关系的数据分片策略，子表的记录与所<br>关联的父表记录存放在同一个数据分片上</p>
<p><strong>修改 schema.xml 配置文件</strong></p>
<p>配置orders的子表orders_detail,使用外键order_id进行分片,这样与orders表的数据分布紧密</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span>  <span class="attr">rule</span>=<span class="string">&quot;mod_rule&quot;</span> &gt;</span>     </span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span> <span class="tag">&lt;/<span class="name">table</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<p><strong>在 dn2 创建 orders_detail 表</strong><br><strong>重启 Mycat</strong><br><strong>访问 Mycat 向 orders_detail 表插入数据</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;detail1&#x27;</span>,<span class="number">1</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">&#x27;detail1&#x27;</span>,<span class="number">2</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">&#x27;detail1&#x27;</span>,<span class="number">3</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">&#x27;detail1&#x27;</span>,<span class="number">4</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">&#x27;detail1&#x27;</span>,<span class="number">5</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_detail(<span class="keyword">id</span>,detail,order_id) <span class="keyword">VALUES</span>(<span class="number">6</span>,<span class="string">&#x27;detail1&#x27;</span>,<span class="number">6</span>); </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/19/QfZp5g2eSaNi8DB.png" alt="image-20200519104145287"></p>
<p><strong>在mycat、dn1、dn2中运行两个表join语句</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> o.*,od.detail <span class="keyword">from</span> orders o </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> orders_detail od <span class="keyword">on</span> o.id=od.order_id; </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/19/5NiYIbGAkLgMw4W.png" alt="image-20200519104338407"></p>
<h3 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a><strong>全局表</strong></h3><p>在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间的关联，<br>就成了比较 棘手的问题，考虑到字典表具有以下几个特性：<br>① 变动不频繁<br>② 数据量总体变化不大<br>③ 数据规模不大，很少有超过数十万条记录 </p>
<p>鉴于此，Mycat 定义了一种特殊的表，称之为“全局表”，全局表具有以下特性： </p>
<ul>
<li>全局表的插入、更新操作会实时在所有节点上执行，保持各个分片的数据一致性 </li>
<li>全局表的查询操作，只从一个节点获取 </li>
<li>全局表可以跟任何一个表进行 JOIN 操作 </li>
</ul>
<p>将字典表或者符合字典表特性的一些表定义为全局表，则从另外一个方面，很好的解决了数据<br>JOIN 的难题。通过全局表+基于 E-R 关系的分片策略，Mycat 可以满足 80%以上的企业应用开发 </p>
<p><strong>修改 schema.xml 配置文件</strong> </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span>  <span class="attr">rule</span>=<span class="string">&quot;mod_rule&quot;</span> &gt;</span>     </span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span> <span class="tag">&lt;/<span class="name">table</span>&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- 定义全局字典表 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;dict_order_type&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>在 dn2 创建 dict_order_type 表</strong><br><strong>重启 Mycat</strong><br><strong>访问 Mycat 向 dict_order_type 表插入数据</strong> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dict_order_type(<span class="keyword">id</span>,order_type) <span class="keyword">VALUES</span>(<span class="number">101</span>,<span class="string">&#x27;type1&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dict_order_type(<span class="keyword">id</span>,order_type) <span class="keyword">VALUES</span>(<span class="number">102</span>,<span class="string">&#x27;type2&#x27;</span>); </span><br></pre></td></tr></table></figure>

<p>在Mycat、dn1、dn2中查询表数据 </p>
<p><img src="https://i.loli.net/2020/05/19/bhZ6VcOHtdqkYJX.png" alt="image-20200519105523571"></p>
<h2 id="常用分片规则"><a href="#常用分片规则" class="headerlink" title="常用分片规则"></a>常用分片规则</h2><h3 id="取模"><a href="#取模" class="headerlink" title="取模"></a><strong>取模</strong></h3><p> 此规则为对分片字段求摸运算。也是水平分表最常用规则。</p>
<h3 id="分片枚举"><a href="#分片枚举" class="headerlink" title="分片枚举"></a><strong>分片枚举</strong></h3><p>通过在配置文件中配置可能的枚举 id，自己配置分片，本规则适用于特定的场景，比如有些业务<br>需要按照省份或区县来做保存，而全国省份区县固定的，这类业务使用本条规则。 </p>
<ul>
<li><p>修改schema.xml配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 分片枚举 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders_ware_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding_by_intfile&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改rule.xml配置文件 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_intfile&quot;</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>areacode<span class="tag">&lt;/<span class="name">columns</span>&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span>         </span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span> </span><br><span class="line">… </span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span>             <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span>                 			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span>         </span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<p><code>columns</code>：分片字段，<code>algorithm</code>：分片函数 </p>
<p><code>mapFile</code>：标识配置文件名称，<code>type</code>：分片字段类型0为int型、非0为String  </p>
<p><code>defaultNode</code>：默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错 </p>
</li>
<li><p>修改<code>partition-hash-int.txt</code>配置文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">110&#x3D;0  </span><br><span class="line">120&#x3D;1 </span><br><span class="line">#110走dn1, 120走dn2</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 Mycat</p>
</li>
<li><p>访问Mycat创建表 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#订单归属区域信息表   </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>  orders_ware_info (     </span><br><span class="line">    <span class="string">`id`</span>        <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">comment</span> <span class="string">&#x27;编号&#x27;</span>,     </span><br><span class="line">    <span class="string">`order_id`</span>     <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">&#x27;订单编号&#x27;</span>,     </span><br><span class="line">    <span class="string">`address`</span>    <span class="built_in">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">comment</span> <span class="string">&#x27;地址&#x27;</span>,</span><br><span class="line">    <span class="string">`areacode`</span>  <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">comment</span> <span class="string">&#x27;区域编号&#x27;</span>, </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>插入数据 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_ware_info(<span class="keyword">id</span>, order_id,address,areacode) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;110&#x27;</span>); <span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_ware_info(<span class="keyword">id</span>, order_id,address,areacode) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">2</span>,<span class="string">&#x27;天津&#x27;</span>,<span class="string">&#x27;120&#x27;</span>); </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/19/ysuzLmniYANdl7c.png" alt="image-20200519140826389"></p>
</li>
</ul>
<h3 id="范围约定"><a href="#范围约定" class="headerlink" title="范围约定"></a>范围约定</h3><p>此分片适用于，提前规划好分片字段某个范围属于哪个分片。 </p>
<ul>
<li><p>修改schema.xml配置文件 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;payment_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto_sharding_long&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改rule.xml配置文件 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto_sharding_long&quot;</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>order_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span>         </span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">… </span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span>                 <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span>                 			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span>        </span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>columns</code>：分片字段，<code>algorithm</code>：分片函数  <code>mapFile</code>：标识配置文件名称</p>
<p> <code>defaultNode</code>：默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就 报错 </p>
</li>
<li><p>修改autopartition-long.txt配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0-102&#x3D;0 </span><br><span class="line">103-200&#x3D;1  </span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 Mycat </p>
</li>
<li><p>访问Mycat创建表 </p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#支付信息表   </span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>  payment_info (     </span><br><span class="line">    <span class="string">`id`</span>        <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">comment</span> <span class="string">&#x27;编号&#x27;</span>,     </span><br><span class="line">    <span class="string">`order_id`</span>     <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">&#x27;订单编号&#x27;</span>,     </span><br><span class="line">    <span class="string">`payment_status`</span>    <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">&#x27;支付状态&#x27;</span>,     </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>) </span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>插入数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id,payment_status) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">101</span>,<span class="number">0</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id,payment_status) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">102</span>,<span class="number">1</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id ,payment_status) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="number">103</span>,<span class="number">0</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> payment_info (<span class="keyword">id</span>,order_id,payment_status) <span class="keyword">VALUES</span> (<span class="number">4</span>,<span class="number">104</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>查询Mycat、dn1、dn2可以看到数据分片效果 </li>
</ul>
<p><img src="https://i.loli.net/2020/05/19/ifvRxBLUYjcDp7G.png" alt="image-20200519142804687"></p>
<h3 id="日期-天-分片"><a href="#日期-天-分片" class="headerlink" title="日期(天)分片"></a>日期(天)分片</h3><ul>
<li><p>修改schema.xml配置文件 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 日期分片 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;login_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding_by_date&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span> 	</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改rule.xml配置文件 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_date&quot;</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>login_date<span class="tag">&lt;/<span class="name">columns</span>&gt;</span>                         </span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>shardingByDate<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span>         </span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;shardingByDate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2019-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span>                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2019-01-04<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span>          </span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>columns</code>：分片字段，<code>algorithm</code>：分片函数  <code>dateFormat</code> ：日期格式  <code>sBeginDate</code> ：开始日期  </p>
<p><code>sEndDate</code>：结束日期,则代表数据达到了这个日期的分片后循环从开始分片插入</p>
<p><code>sPartionDay</code> ：分区天数，即默认从开始日期算起，分隔 2 天一个分区 </p>
</li>
<li><p>重启 Mycat </p>
</li>
<li><p>访问Mycat创建表</p>
</li>
<li><p>用户信息表   </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>  login_info (     </span><br><span class="line">    <span class="string">`id`</span>        <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">comment</span> <span class="string">&#x27;编号&#x27;</span>,     </span><br><span class="line">    <span class="string">`user_id`</span>     <span class="built_in">INT</span> <span class="keyword">comment</span> <span class="string">&#x27;用户编号&#x27;</span>,     </span><br><span class="line">    <span class="string">`login_date`</span>    <span class="built_in">date</span> <span class="keyword">comment</span> <span class="string">&#x27;登录日期&#x27;</span>,     </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>)</span><br><span class="line">);  </span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">101</span>,<span class="string">&#x27;2019-01-01&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">102</span>,<span class="string">&#x27;2019-01-02&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="number">103</span>,<span class="string">&#x27;2019-01-03&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">4</span>,<span class="number">104</span>,<span class="string">&#x27;2019-01-04&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">5</span>,<span class="number">103</span>,<span class="string">&#x27;2019-01-05&#x27;</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> login_info(<span class="keyword">id</span>,user_id,login_date) <span class="keyword">VALUES</span> (<span class="number">6</span>,<span class="number">104</span>,<span class="string">&#x27;2019-01-06&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询Mycat、dn1、dn2可以看到数据分片效果 </p>
</li>
</ul>
<p><img src="https://i.loli.net/2020/05/19/RNLUr5a6AsQtknK.png" alt="image-20200519144530199"></p>
<h2 id="全局序列"><a href="#全局序列" class="headerlink" title="全局序列"></a>全局序列</h2><p>在实现分库分表的情况下，数据库自增主键已无法保证自增主键的全局唯一。为此，Mycat 提供<br>了全局 sequence，并且提供了包含本地配置和数据库配置等多种实现方式 </p>
<p><strong>1、 本地文件</strong><br>此方式 Mycat 将 sequence 配置到文件中，当使用到 sequence 中的配置后，Mycat 会更新<br>classpath 中的 sequence_conf.properties 文件中 sequence 当前的值。 </p>
<ul>
<li><p>优点：本地加载，读取速度较快 </p>
</li>
<li><p>缺点：抗风险能力差，Mycat 所在主机宕机后，无法读取本地文件。 </p>
</li>
</ul>
<p><strong>2、 数据库方式</strong><br>利用数据库一个表 来进行计数累加。但是并不是每次生成序列都读写数据库，这样效率太低。<br>Mycat 会预加载一部分号段到 Mycat 的内存中，这样大部分读写序列都是在内存中完成的。<br>如果内存中的号段用完了 Mycat 会再向数据库要一次。 </p>
<p>问：那如果 Mycat 崩溃了 ，那内存中的序列岂不是都没了？<br>是的。如果是这样，那么 Mycat 启动后会向数据库申请新的号段，原有号段会弃用。<br>也就是说如果 Mycat 重启，那么损失是当前的号段没用完的号码，但是不会因此出现主键重复 </p>
<ul>
<li><p>全局序列表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在 dn1 上创建全局序列表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> MYCAT_SEQUENCE (</span><br><span class="line">    <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    current_value <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">increment</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">100</span>, </span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">NAME</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span>; </span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>创建全局序列所需函数 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_currval(seq_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>)) <span class="keyword">RETURNS</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>)</span><br><span class="line"><span class="keyword">DETERMINISTIC</span>   </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">DECLARE</span> retval <span class="built_in">VARCHAR</span>(<span class="number">64</span>); </span><br><span class="line"><span class="keyword">SET</span> retval=<span class="string">&quot;-999999999,null&quot;</span>; </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(<span class="keyword">CAST</span>(current_value <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="string">&quot;,&quot;</span>,<span class="keyword">CAST</span>(<span class="keyword">increment</span> <span class="keyword">AS</span> <span class="built_in">CHAR</span>)) <span class="keyword">INTO</span> retval <span class="keyword">FROM</span> MYCAT_SEQUENCE </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NAME</span> = seq_name;</span><br><span class="line">RETURN retval; </span><br><span class="line"><span class="keyword">END</span> $$ </span><br><span class="line">DELIMITER ; </span><br><span class="line"></span><br><span class="line">DELIMITER $$ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_setval(seq_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>),<span class="keyword">VALUE</span> <span class="built_in">INTEGER</span>) <span class="keyword">RETURNS</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) </span><br><span class="line"><span class="keyword">DETERMINISTIC</span> </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">UPDATE</span> MYCAT_SEQUENCE </span><br><span class="line"><span class="keyword">SET</span> current_value = <span class="keyword">VALUE</span> </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NAME</span> = seq_name; </span><br><span class="line">RETURN mycat_seq_currval(seq_name); </span><br><span class="line"><span class="keyword">END</span> $$ D</span><br><span class="line">ELIMITER ; </span><br><span class="line"></span><br><span class="line">DELIMITER $$ </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> mycat_seq_nextval(seq_name <span class="built_in">VARCHAR</span>(<span class="number">50</span>)) <span class="keyword">RETURNS</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>)  <span class="keyword">DETERMINISTIC</span> </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">UPDATE</span> MYCAT_SEQUENCE </span><br><span class="line"><span class="keyword">SET</span> current_value = current_value + <span class="keyword">increment</span> </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NAME</span> = seq_name; </span><br><span class="line">RETURN mycat_seq_currval(seq_name); </span><br><span class="line"><span class="keyword">END</span> $$ </span><br><span class="line">DELIMITER ; </span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化序列表记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> MYCAT_SEQUENCE(<span class="keyword">NAME</span>,current_value,<span class="keyword">increment</span>) <span class="keyword">VALUES</span> (<span class="string">&#x27;ORDERS&#x27;</span>, <span class="number">400000</span>, <span class="number">100</span>); </span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 Mycat 配置 </p>
<p>修改<code>sequence_db_conf.properties</code> </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sequence stored in datanode</span></span><br><span class="line"><span class="attr">GLOBAL</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">COMPANY</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">CUSTOMER</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">ORDERS</span>=<span class="string">dn1</span></span><br></pre></td></tr></table></figure>

<p>意思是 ORDERS这个序列在dn1这个节点上，具体dn1节点是哪台机子，请参考schema.xml </p>
</li>
<li><p>修改server.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>全局序列类型：0-本地文件，1-数据库方式，2-时间戳方式。此处应该修改成1。 </p>
</li>
<li><p>重启Mycat </p>
</li>
<li><p>验证全局序列<br>登录 Mycat，插入数据,id使用<code>MYCATSEQ_ORDERS</code>全局序列表中的下一个值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders(<span class="keyword">id</span>,amount,customer_id,order_type) <span class="keyword">values</span>(<span class="keyword">next</span> <span class="keyword">value</span> <span class="keyword">for</span> MYCATSEQ_ORDERS,<span class="number">1000</span>,<span class="number">101</span>,<span class="number">102</span>); </span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/19/1RouN4We3VJlOTz.png" alt="image-20200519152659030"></p>
</li>
<li><p>重启Mycat后，再次插入数据，再查询 </p>
<p><img src="https://i.loli.net/2020/05/19/PcFlzWhGDpCQa1r.png" alt="image-20200519152918153"></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"># 数据库中间件</a>
              <a href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" rel="tag"># 分库分表</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/06/12/MySQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%92%8C%E7%B4%A2%E5%BC%95/" rel="prev" title="MySQL存储引擎和索引">
      <i class="fa fa-chevron-left"></i> MySQL存储引擎和索引
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/26/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="next" title="Redis学习笔记">
      Redis学习笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Mycat%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">Mycat数据库中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="nav-number">1.1.</span> <span class="nav-text">安装启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">1.2.</span> <span class="nav-text">读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.1.</span> <span class="nav-text">主机配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.2.</span> <span class="nav-text">从机配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="nav-number">1.2.3.</span> <span class="nav-text">一主一从</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E"><span class="nav-number">1.2.4.</span> <span class="nav-text">双主双从</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86%E2%80%94%E2%80%94%E5%88%86%E5%BA%93"><span class="nav-number">1.3.</span> <span class="nav-text">垂直拆分——分库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86%E2%80%94%E2%80%94%E5%88%86%E8%A1%A8"><span class="nav-number">1.4.</span> <span class="nav-text">水平拆分——分表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mycat-%E7%9A%84%E5%88%86%E7%89%87-%E2%80%9Cjoin%E2%80%9D"><span class="nav-number">1.5.</span> <span class="nav-text">Mycat 的分片 “join”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ER-%E8%A1%A8"><span class="nav-number">1.5.1.</span> <span class="nav-text">ER 表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="nav-number">1.5.2.</span> <span class="nav-text">全局表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="nav-number">1.6.</span> <span class="nav-text">常用分片规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E6%A8%A1"><span class="nav-number">1.6.1.</span> <span class="nav-text">取模</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%89%87%E6%9E%9A%E4%B8%BE"><span class="nav-number">1.6.2.</span> <span class="nav-text">分片枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E7%BA%A6%E5%AE%9A"><span class="nav-number">1.6.3.</span> <span class="nav-text">范围约定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E6%9C%9F-%E5%A4%A9-%E5%88%86%E7%89%87"><span class="nav-number">1.6.4.</span> <span class="nav-text">日期(天)分片</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%BA%8F%E5%88%97"><span class="nav-number">1.7.</span> <span class="nav-text">全局序列</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="hzy"
      src="/uploads/cat.jpg">
  <p class="site-author-name" itemprop="name">hzy</p>
  <div class="site-description" itemprop="description">记录学习的过程</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/growup-hzy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;growup-hzy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/edcfanshzy@163.com" title="E-Mail → edcfanshzy@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hzy</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
